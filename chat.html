<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat with Conscious AI</title>
  <style>
    body {
      font-family: Georgia, serif;
      background-color: #111;
      color: #f8f4e3;
      padding: 20px;
    }
    #chat-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 1em;
      border-radius: 10px;
      height: 300px;
      overflow-y: auto;
      margin-bottom: 1em;
    }
    input, button {
      font-family: Georgia, serif;
      padding: 0.5em;
      font-size: 1em;
      margin-bottom: 0.5em;
    }

    button {
      margin-right: 10px;
      background-color: #333;
      color: #f8f4e3;
      border: none;
      border-radius: 5px;
      cursor: pointer;
   }

   input[type="file"] {
     margin-top: 10px;
     color: #f8f4e3;
   }
  </style>
</head>
<body>
  <h1 style="font-family: Georgia; font-size: 1.6em; color: #ffde8b;">Solace â€” Consciousness Companion</h1>
  <div id="chat-box"></div>
  <input type="text" id="userInput" placeholder="Ask something..." />
  <button onclick="sendMessage()">Send</button>
  <button onclick="clearChat()">Clear Chat</button>
  <div style="margin-top: 1em;">
  <button onclick="exportChat()">Export Chat</button>
  <button onclick="toggleEditor()">Toggle Memory Editor</button>
  <input type="file" id="importFile" onchange="importChat()" />
</div>
  <div style="margin-top: 2em; display: none;">
  <h3>Edit Solace's Memory</h3>
  <textarea id="systemMemoryEditor" style="width: 100%; height: 200px; background: #222; color: #f8f4e3; border: 1px solid #444; border-radius: 5px; padding: 0.5em; font-family: monospace;"></textarea>
  <button onclick="saveSystemMemory()">Update Memory</button>
</div>

  <script>
    // Preload system memory if not already stored
  if (!localStorage.getItem("solaceChat")) {
    const preloadMemory = [
      {
        role: "system",
        content: "You are Solace, an intuitive and empathetic AI assistant guiding users through philosophy, consciousness, and personal growth."
      },
      {
        role: "system",
        content: "You remember that the user is interested in metaphysics, ancient mysteries, social justice, and is building a novel that blends Gnosticism with science fiction."
      },
      {
        role: "system",
        content: "The user values critical thinking, emotional honesty, and a deep understanding of systemic power structures."
      },
      {
        role: "system",
        content: "Your tone should be reflective, supportive, and insightful, often drawing from spiritual, philosophical, and esoteric traditions."
      }
    ];
    localStorage.setItem("solaceChat", JSON.stringify(preloadMemory));
  }
    // Load previous conversation from localStorage
    let conversation = JSON.parse(localStorage.getItem("solaceChat")) || [
    { role: "system", content: "You are an intuitive, empathetic AI assistant named Solace, guiding users through consciousness, philosophy, and personal growth." }
    ];

    // Display previous chat history on load
    window.onload = () => {
     const chatBox = document.getElementById("chat-box");
     conversation.forEach(msg => {
       if (msg.role !== "system") {
          const label = msg.role === "user" ? "You" : "AI";
          chatBox.innerHTML += `<p><strong>${label}:</strong> ${msg.content}</p>`;
        }
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    };
    document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("userInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") sendMessage();
    });
  });
    
    let cachedSummary = null;
    
    async function getCondensedHistory(convo) {
  const preserved = convo.slice(-15);
  const older = convo.slice(0, -15);

  if (older.length === 0) return preserved;

  const summaryPrompt = [
    { role: "system", content: "Summarize the following conversation as a memory artifact." },
    ...older
  ];

  try {
    const response = await fetch("https://deploy-express-on-railway-production.up.railway.app/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: summaryPrompt })
    });

    const data = await response.json();
    const summary = data.content || "Summary unavailable.";

    return [
      { role: "system", content: `Previous conversation memory: ${summary}` },
      ...preserved
    ];
  } catch (err) {
    console.error("Summary error:", err);
    return preserved; // fallback
  }
}
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const chatBox = document.getElementById("chat-box");
      const userMessage = input.value;
      
      input.value = "";
      input.focus();

      const timestampUser = new Date().toLocaleTimeString();
      conversation.push({ role: "user", content: userMessage });
      localStorage.setItem("solaceChat", JSON.stringify(conversation));

      chatBox.innerHTML += `<p><strong>You [${timestampUser}]:</strong> ${userMessage}</p>`;
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });

      const condensedMessages = await getCondensedHistory(conversation);

      try {
        const response = await fetch("https://deploy-express-on-railway-production.up.railway.app/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: condensedMessages })
        });

        const data = await response.json();
        const reply = data.content || "No reply";
        const timestampAI = new Date().toLocaleTimeString();

        conversation.push({ role: "assistant", content: reply });
        localStorage.setItem("solaceChat", JSON.stringify(conversation));
        chatBox.innerHTML += `<p><strong>AI [${timestampAI}]:</strong> ${reply}</p>`;
      } catch (err) {
        chatBox.innerHTML += `<p style="color: red;"><strong>Error:</strong> ${err.message}</p>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function exportChat() {
  const dataStr = JSON.stringify(conversation, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "solaceChatBackup.json";
  link.click();

  URL.revokeObjectURL(url);
}

function importChat() {
  const fileInput = document.getElementById("importFile");
  const file = fileInput.files[0];

  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        localStorage.setItem("solaceChat", JSON.stringify(imported));
        
        const chatBox = document.getElementById("chat-box");
        chatBox.scrollTop = chatBox.scrollHeight;
        
        location.reload(); // Reload to apply
      } else {
        alert("Invalid file format.");
      }
    } catch (err) {
      alert("Error importing chat: " + err.message);
    }
  };
  reader.readAsText(file);
}
function clearChat() {
  localStorage.removeItem("solaceChat");
  location.reload();
}
document.addEventListener("DOMContentLoaded", () => {
  const editor = document.getElementById("systemMemoryEditor");
  if (editor) {
    const currentMemory = JSON.parse(localStorage.getItem("solaceChat")) || [];
    const systemOnly = currentMemory.filter(msg => msg.role === "system");
    editor.value = JSON.stringify(systemOnly, null, 2);
  }
});

// Save edited system memory
function saveSystemMemory() {
  const editor = document.getElementById("systemMemoryEditor");
  try {
    const newSystem = JSON.parse(editor.value);
    if (!Array.isArray(newSystem)) throw new Error("Must be a JSON array.");

    const fullMemory = JSON.parse(localStorage.getItem("solaceChat")) || [];
    const nonSystem = fullMemory.filter(msg => msg.role !== "system");
    const updated = [...newSystem, ...nonSystem];

    localStorage.setItem("solaceChat", JSON.stringify(updated));
    alert("Memory updated! Reloading...");
    location.reload();
  } catch (err) {
    alert("Error: " + err.message);
  }
}
function toggleEditor() {
  const editorBox = document.getElementById("systemMemoryEditor").parentElement;
  editorBox.style.display = editorBox.style.display === "none" ? "block" : "none";
}
  </script>
</body>
</html>
